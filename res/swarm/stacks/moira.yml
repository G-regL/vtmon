version: "3.6"

services:
  redis:
    image: redis:5.0.5-alpine
    command: redis-server --appendonly yes
    deploy:
      mode: replicated
      replicas: 1
    volumes:
      - /opt/docker/stack.moira/service.redis/data:/data

  redis-commander:
    image: rediscommander/redis-commander:latest
    networks:
      - default
      - traefik-net
    deploy:
      mode: replicated
      replicas: 0
      labels:
        - "traefik.enable=true"
        - "traefik.frontend.rule=PathPrefixStrip:/moira-redis/"
        - "traefik.port=8081"
    environment:
      - REDIS_HOSTS=local:redis:6379:0
    

  filter:
    image: moira/filter
    depends_on:
      - redis
    configs:
#      - source: Moira_filter-schemas.conf-20190530.1450
#        target: /etc/moira/storage-schemas.conf
      - source: Moira_filter-filter.yml-20190530.1438
        target: /etc/moira/filter.yml
    networks:
      - default
      - graphhouse-net
    deploy:
      mode: replicated
      replicas: 1

  checker:
    image: moira/checker
    depends_on:
      - redis
      - filter
    networks:
      - default
      - graphhouse-net
    configs:
      - source: Moira_checker-checker.yml-20190530.1454
        target: /etc/moira/checker.yml
    deploy:
      mode: replicated
      replicas: 1

  notifier:
    image: moira/notifier
    depends_on:
      - redis
      - checker
    networks:
      - default
      - graphhouse-net
    deploy:
      mode: replicated
      replicas: 1
    configs:
      - source: Moira_notifier-notifier.yml-20190531.1153
        target: /etc/moira/notifier.yml  
      

  api:
    image: moira/api
    depends_on:
      - redis
      - checker
    networks:
      - default
#      - traefik-net
      - graphhouse-net
    configs:
      - source: Moira_api-api.yml-20190530.1503
        target: /etc/moira/api.yml
    deploy:
      mode: replicated
      replicas: 1
#      labels:
#        - "traefik.enable=true"
#        - "traefik.frontend.rule=PathPrefix:/moira/api/"
#        - "traefik.port=8081"

  web:
    image: moira/web2
#    environment:
#      - MOIRA_API_URI=${HOSTIPFQDN}/moira/api
    networks:
      - default
#      - traefik-net
      - graphhouse-net
    deploy:
      mode: replicated
      replicas: 1
#      labels:
#        - "traefik.enable=true"
#        - "traefik.frontend.rule=PathPrefix:/moira/"
#        - "traefik.port=80"

  balancer:
    image: nginx:alpine
    ports:
      - 8083:8083
    depends_on:
      - web
      - api
#    networks:
#      - default
#      - traefik-net
    deploy:
      mode: replicated
      replicas: 1
#      labels:
#        - "traefik.enable=true"
#        - "traefik.frontend.rule=PathPrefix:/moira/"
#        - "traefik.port=8083"
    configs:
      - source: Moira_balancer_nginx.conf-20190531.0727
        target: /etc/nginx/conf.d/moira.conf
        
configs:
  Moira_filter-schemas.conf-20190530.1450:
    external: true
  Moira_filter-filter.yml-20190530.1438:
    external: true
  Moira_checker-checker.yml-20190530.1454:
    external: true
  Moira_api-api.yml-20190530.1503:
    external: true
  Moira_balancer_nginx.conf-20190531.0727:
    external: true
  Moira_notifier-notifier.yml-20190531.1153:
    external: true
    
networks:
  traefik-net:
    external: true
  graphhouse-net:
    external: true